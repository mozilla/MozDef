AWSTemplateFormatVersion: 2010-09-09
Description: Create MozDef EC2 security groups
Parameters:
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: The VPC ID of the VPC to deploy in
  SSHIngressCIDR:
    Type: String
    AllowedPattern: '^([0-9]{1,3}\.){3}[0-9]{1,3}(\/([0-9]|[1-2][0-9]|3[0-2]))?$'
    ConstraintDescription: A valid CIDR (e.g. 203.0.113.0/24)
    Description: The CIDR of IP addresses from which to allow inbound SSH connections
Resources:
  MozDefSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security Group of the MozDef EC2 instance
      SecurityGroupEgress:
      - IpProtocol: '-1'
        CidrIp: 0.0.0.0/0
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: 22
        ToPort: 22
        CidrIp: !Ref SSHIngressCIDR
      - IpProtocol: tcp
        FromPort: 80
        ToPort: 80
        SourceSecurityGroupId: !Ref MozDefLoadBalancerSecurityGroup
      - Description: Allow 9090 inbound from loadbalancer
        IpProtocol: tcp
        FromPort: 9090
        ToPort: 9090
        SourceSecurityGroupId: !Ref MozDefLoadBalancerSecurityGroup
      Tags:
        - Key: application
          Value: mozdef
        - Key: stack
          Value: !Ref AWS::StackName
      VpcId: !Ref VpcId
  MozDefLoadBalancerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security Group of the MozDef ALB
      SecurityGroupEgress:
        - Description: Allow all egress traffic
          IpProtocol: '-1'
          CidrIp: 0.0.0.0/0
      SecurityGroupIngress:
        - Description: Allow 443 inbound from everywhere
          IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
        - Description: Allow 80 inbound from everywhere for redirection
          IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - Description: Allow 9090 inbound from everywhere
          IpProtocol: tcp
          FromPort: 9090
          ToPort: 9090
          CidrIp: 0.0.0.0/0
        - Description: Allow 9443 inbound from everywhere
          IpProtocol: tcp
          FromPort: 9443
          ToPort: 9443
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: application
          Value: mozdef
        - Key: stack
          Value: !Ref AWS::StackName
      VpcId: !Ref VpcId
Outputs:
  MozDefSecurityGroupId:
    Description: The security group ID of the MozDef EC2 instance security group
    Value: !GetAtt MozDefSecurityGroup.GroupId
  MozDefLoadBalancerSecurityGroupId:
    Description: The security group ID of the MozDef load balancer security group
    Value: !GetAtt MozDefLoadBalancerSecurityGroup.GroupId
